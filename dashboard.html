<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <title>I4Inari UI Kit</title>

    <!-- CSS -->
    <link rel="stylesheet" href="assets/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Nunito:200,400,600,800">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Alata&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

   <style>
    body {
        font-family: 'Nunito', sans-serif;
        background-color: #1a1a2e;
    }
    .card {
        background-color: rgba(42, 52, 84, 0.8);
        border-radius: 0.85rem;
        border: none;
    }
    .no-border { border: none; }
    .border-online { border: 2px solid #1cc88a; }
    .border-offline { border: 2px solid #e74b3b; }
    .fill { min-height: 100vh; }

    /* ‚≠ê NEW CSS YOU MUST ADD ‚≠ê */
    #ove09card h1 {
        color: gray !important;
    }
    #ove_09_p1 svg path {
        stroke: transparent !important;
    }

	/* CURRENT CARD OLD UI */
#ove09card {
    border: 2px solid rgba(150,150,150,0.3);
    border-radius: 12px;
}

#ove09card h1 {
    color: #b2beb5 !important;
}

#ove_09_p1 svg path {
    stroke: #b2beb5 !important;    /* grey meter */
    stroke-width: 8 !important;
}

#ove_09_p1 svg {
    filter: drop-shadow(0px 0px 4px #666);
}

</style>


    <!-- JS Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.2.3/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/progressbar.js/1.1.0/progressbar.min.js"></script>

    <script>
    $(document).ready(function () {

        let stepsize = 250;

        /* ==========================================================
           FIXED TEMPERATURE PROGRESS BAR (0‚Äì50¬∞C)
        ========================================================== */
        window.liveTemp = 0;

        var ove06p1 = new ProgressBar.Circle("#ove_06_p1", {
            strokeWidth: 9,
            color: '#1cc88a',
            trailColor: '#97a4b7',
            trailWidth: 0.3,
            easing: 'easeInOut',
            duration: 800,
            text: { autoStyleContainer: false },
            svgStyle: null,

            step: (state, bar) => {
                let temp = Number(window.liveTemp);

                bar.setText(
                    '<span style="color:#01ffff;">TEMP</span><br>' +
                    temp.toFixed(1) + "¬∞C"
                );

                let holder = document.getElementById("ove_06_p1");

                // Color logic
                if (temp >= 40) {
                    bar.path.setAttribute("stroke", "#ee5253");
                } else if (temp >= 30) {
                    bar.path.setAttribute("stroke", "#16a085");
                } else {
                    bar.path.setAttribute("stroke", "#3498db");
                }

                holder.style.width = "130px";
            }
        });

        ove06p1.text.style.fontSize = '15px';
        ove06p1.text.style.color = '#FFFFFF';
        window.ove06p1 = ove06p1;


        /* ==========================================================
           HUMIDITY PROGRESS BAR (0‚Äì100%)
        ========================================================== */
        window.liveHum = 0;

        var ove13p1 = new ProgressBar.Circle("#ove_13_p1", {
            strokeWidth: 9,
            color: '#1cc88a',
            trailColor: '#97a4b7',
            duration: 900,
            text: { autoStyleContainer: false },

            step: (state, bar) => {
                let hum = Math.round(bar.value() * 100);

                bar.setText(
                    '<span style="color:#01ffff;">HUM</span><br>' +
                    hum + "%"
                );

                let holder = document.getElementById("ove_13_p1");

                if (hum >= 80) bar.path.setAttribute("stroke", "#ee5253");
                else if (hum >= 60) bar.path.setAttribute("stroke", "#16a085");
                else bar.path.setAttribute("stroke", "#3498db");

                holder.style.width = "130px";
            }
        });

        ove13p1.text.style.fontSize = '15px';
        ove13p1.text.style.color = '#FFFFFF';
        window.ove13p1 = ove13p1;


        /* ==========================================================
           SOUND INTENSITY BAR (0‚Äì5 NORMALIZED)
        ========================================================== */
        window.liveSound = 0;

        var ove07p1 = new ProgressBar.Circle("#ove_07_p1", {
            strokeWidth: 9,
            trailColor: '#97a4b7',
            trailWidth: 0.3,
            duration: 900,
            text: { autoStyleContainer: false },

            step: (state, bar) => {
                let val = Number(window.liveSound).toFixed(3);

                bar.setText(
                    '<span style="color:#01ffff;">SOUND</span><br>' +
                    val
                );

                bar.path.setAttribute("stroke", "#01ffff");

                document.getElementById("ove_07_p1").style.width = "130px";
            }
        });

        ove07p1.text.style.fontSize = '15px';
        ove07p1.text.style.color = '#FFFFFF';
        window.ove07p1 = ove07p1;


        /* ==========================================================
           VIBRATION BAR (0‚Äì5 NORMALIZED)
        ========================================================== */
        window.liveVib = 0;

        var ove08p1 = new ProgressBar.Circle("#Vibration", {
            strokeWidth: 9,
            trailColor: '#97a4b7',
            trailWidth: 0.3,
            duration: 900,
            text: { autoStyleContainer: false },

            step: (state, bar) => {
                let vib = Number(window.liveVib).toFixed(3);

                bar.setText(
                    '<span style="color:#01ffff;">VIB</span><br>' +
                    vib
                );

                bar.path.setAttribute("stroke", "#f39c12");

                document.getElementById("Vibration").style.width = "130px";
            }
        });

        ove08p1.text.style.fontSize = '15px';
        ove08p1.text.style.color = '#FFFFFF';
        window.ove08p1 = ove08p1;


        /* ==========================================================
           CURRENT, VOLTAGE, ETC. (UNTOUCHED)
           ‚Äî These will update using updateDashboard()
        ========================================================== */

    });
    </script>
</head>
<body id="page-top" style="background-image: url('moto_wall.jpg'); background-repeat: no-repeat; background-attachment: fixed; background-size: 100% 100%;">
    <div id="wrapper">
        <div class="d-flex flex-column fill" id="content-wrapper" style="background-color: transparent;">
            <div id="content">
                <div class="container-fluid">

                    <!-- HEADER -->
                    <div class="row mb-3 mt-4 align-items-center">
                        <div class="col-md-10 col-xl-10">
                            <h1 style="color:white;font-size:15px;font-family:Alata;">
                                <span id="gomain" style="cursor:pointer;">
                                    <i class="fas fa-home"></i>&nbsp;&nbsp;&nbsp;&nbsp;Main
                                </span>
                                &nbsp;/&nbsp;
                                <span id="gohome" style="cursor:pointer;">Dashboard</span>
                                &nbsp;/&nbsp;Motor
                            </h1>
                        </div>
                    </div>

                    <!-- CONNECTIVITY -->
                    <div class="row align-items-end">

                        <!-- TOTAL MOTORS -->
                        <div class="col-md-12 col-xl-2">
                            <div class="card py-0 border-offline" id="ovennum" style="cursor:pointer; margin-bottom:19px;">
                                <div class="card-body">
                                    <div class="row align-items-center no-gutters">
                                        <div class="col me-2">
                                            <div style="color:#e74b3b;font-size:14px;">Total No.<br>of Motors</div>
                                            <div><span id="ovennumspan" style="color:white;font-size:23px;">6</span></div>
                                        </div>
                                        <div class="col-auto p-0">
                                            <span class="fa-stack fa-2x">
                                                <i class="fas fa-square fa-stack-1x" style="color:rgba(231,74,59,0.2);font-size:55px;"></i>
                                                <i class="fas fa-fire-alt fa-stack-1x" style="color:#e74b3b;font-size:23px;"></i>
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ONLINE/OFFLINE -->
                        <div class="col-md-12 col-xl-4">
                            <div class="card mb-2 no-border p-3" style="background-color:rgba(25,42,76,0.5);">
                                <div class="row mb-2 text-center">
                                    <h1 style="color:#97a4b7;font-size:15px;font-family:Alata;letter-spacing:2px;">CONNECTIVITY</h1>
                                </div>

                                <div class="row">
                                    <!-- ONLINE -->
                                    <div class="col-md-6 col-xl-6">
                                        <div class="card py-0 border-online mb-0" id="connnum" style="cursor:pointer;">
                                            <div class="card-body">
                                                <div class="row align-items-center no-gutters">
                                                    <div class="col me-1">
                                                        <div style="color:#1cc88a;font-size:14px;">Online</div>
                                                        <div><span id="conn_num" style="color:white;font-size:23px;">1</span></div>
                                                    </div>
                                                    <div class="col-auto p-0">
                                                        <span class="fa-stack fa-2x">
                                                            <i class="fas fa-square fa-stack-1x" style="color:rgba(28,200,138,0.2);font-size:55px;"></i>
                                                            <i class="fas fa-check fa-stack-1x" style="color:#1cc88a;font-size:20px;"></i>
                                                        </span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- OFFLINE -->
                                    <div class="col-md-6 col-xl-6">
                                        <div class="card py-0 border-total mb-0" id="disconnnum" style="cursor:pointer;">
                                            <div class="card-body">
                                                <div class="row align-items-center no-gutters">
                                                    <div class="col">
                                                        <div style="font-size:14px;color:#b2beb5;">Offline</div>
                                                        <div><span id="disconn_num" style="color:white;font-size:23px;">5</span></div>
                                                    </div>
                                                    <div class="col-auto p-0">
                                                        <span class="fa-stack fa-2x">
                                                            <i class="fas fa-square fa-stack-1x" style="color:rgba(178,190,181,0.2);font-size:55px;"></i>
                                                            <i class="fas fa-times fa-stack-1x" style="color:#b2beb5;font-size:24px;"></i>
                                                        </span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                </div>
                            </div>
                        </div>

                        <!-- STABLE -->
                        <div class="col-md-12 col-xl-2">
                            <div class="card py-0 border-online" id="stablenum" style="cursor:pointer;margin-bottom:23px;">
                                <div class="card-body">
                                    <div class="row align-items-center no-gutters">
                                        <div class="col me-2">
                                            <div style="color:#1cc88a;font-size:14px;">Stable</div>
                                            <div><span id="stable_num" style="color:white;font-size:23px;">1</span></div>
                                        </div>
                                        <div class="col-auto p-0">
                                            <span class="fa-stack fa-2x">
                                                <i class="fas fa-square fa-stack-1x" style="color:rgba(28,200,138,0.2);font-size:55px;"></i>
                                                <i class="fas fa-thumbs-up fa-stack-1x" style="color:#1cc88a;font-size:22px;"></i>
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div> <!-- END Connectivity row -->

                    <!-- ALL SENSOR CARDS -->
                    <div class="row" id="all_cards_are_inside_here">

                        <!-- TEMPERATURE -->
                        <div class="col-md-2 col-xl-2">
                            <div class="card mb-4 no-border ovecards" style="cursor:pointer;background-color:rgba(137,23,48,0.7);" id="ove06card">
                                <div class="card-body">
                                    <div class="row mb-1 text-center">
                                        <h1 style="color:white;font-size:18px;font-family:Alata;">Temperature</h1>
                                    </div>
                                    <div class="row">
                                        <div class="col p-2">
                                            <div class="text-center">
                                                <div id="ove_06_p1" style="margin:auto;"></div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row text-center">
                                        <div class="col">
                                            <h1 style="color:#97a4b7;font-size:12px;font-family:Abel;">MIN : 0¬∞C</h1>
                                        </div>
                                        <div class="col">
                                            <h1 style="color:#97a4b7;font-size:12px;font-family:Abel;">MAX : 50¬∞C</h1>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- HUMIDITY -->
                        <div class="col-md-2 col-xl-2">
                            <div class="card mb-4 no-border ovecards" style="cursor:pointer;background-color:rgba(11,97,119,0.7);" id="ove13card">
                                <div class="card-body">
                                    <div class="row mb-1 text-center">
                                        <h1 style="color:white;font-size:18px;font-family:Alata;">Humidity</h1>
                                    </div>
                                    <div class="row">
                                        <div class="col p-2">
                                            <div class="text-center">
                                                <div id="ove_13_p1" style="margin:auto;"></div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row text-center">
                                        <div class="col">
                                            <h1 style="color:#97a4b7;font-size:12px;font-family:Abel;">MIN : 0%</h1>
                                        </div>
                                        <div class="col">
                                            <h1 style="color:#97a4b7;font-size:12px;font-family:Abel;">MAX : 100%</h1>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- SOUND -->
                        <div class="col-md-2 col-xl-2">
                            <div class="card mb-4 no-border ovecards" style="cursor:pointer;background-color:rgba(11,97,119,0.7);" id="ove07card">
                                <div class="card-body">
                                    <div class="row mb-1 text-center">
                                        <h1 style="color:white;font-size:18px;font-family:Alata;">Sound Intensity</h1>
                                    </div>
                                    <div class="row">
                                        <div class="col p-2">
                                            <div class="text-center">
                                                <div id="ove_07_p1" style="margin:auto;"></div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row text-center">
                                        <div class="col">
                                            <h1 style="color:#97a4b7;font-size:12px;font-family:Abel;">MIN : 0</h1>
                                        </div>
                                        <div class="col">
                                            <h1 style="color:#97a4b7;font-size:12px;font-family:Abel;">MAX : 10</h1>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- VIBRATION -->
                        <div class="col-md-2 col-xl-2">
                            <div class="card mb-4 no-border ovecards" style="cursor:pointer;background-color:rgba(11,97,119,0.7);" id="ove08card">
                                <div class="card-body">
                                    <div class="row mb-1 text-center">
                                        <h1 style="color:white;font-size:18px;font-family:Alata;">Vibration</h1>
                                    </div>
                                    <div class="row">
                                        <div class="col p-2">
                                            <div class="text-center">
                                                <div id="Vibration" style="margin:auto;"></div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row text-center">
                                        <div class="col">
                                            <h1 style="color:#97a4b7;font-size:12px;font-family:Abel;">MIN : 0</h1>
                                        </div>
                                        <div class="col">
                                            <h1 style="color:#97a4b7;font-size:12px;font-family:Abel;">MAX : 5</h1>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- CURRENT -->
                        <div class="col-md-2 col-xl-2">
						    <div class="card mb-4 no-border" style="background-color: rgba(54, 69, 79, 0.5);" id="ove09card">
								<div class="card-body">
									<div class="row mb-1" style="margin-left: 7px; margin-top: 0px; text-align: center;margin-right: 7px;">
										<h1 style="color: gray;font-size: 18px;font-family: Alata, sans-serif;font-weight: bold;">Current</h1>
									</div>
									<div class="row" style="margin-left: 7px; margin-right: 7px; margin-bottom: 32px;">
										<div class="col p-2">
											<div class="row text-center">
												<div id="ove_09_p1" style="margin: auto;"></div>
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>

                        <!-- VOLTAGE -->
                        <div class="col-md-2 col-xl-2">
                            <div class="card mb-4 no-border ovecards" style="cursor:pointer;background-color:rgba(11,97,119,0.7);" id="esd10card">
                                <div class="card-body">
                                    <div class="row mb-3 text-center">
                                        <h1 style="color:white;font-size:18px;font-family:Alata;">Voltage</h1>
                                    </div>
                                    <div class="row mb-3 text-center">
                                        <div style="width:100%;height:53px;" id="esd_10_p1"></div>
                                    </div>
                                    <div class="row mb-3">
                                        <!-- <div class="col text-center" style="background:#090d24;border-radius:20px;padding-top:8px;margin-left:65px;margin-right:65px;">
                                            <h1 style="color:#01ffff;font-size:18px;font-family:Abel;">208V</h1>
                                        </div> -->
                                    </div>
                                    <div class="row text-center">
                                        <div class="col">
                                            <h1 style="color:#97a4b7;font-size:12px;font-family:Abel;">MIN : -220V</h1>
                                        </div>
                                        <div class="col">
                                            <h1 style="color:#97a4b7;font-size:12px;font-family:Abel;">MAX : 220V</h1>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div><!-- END sensor cards row -->

                </div><!-- END container-fluid -->
            </div><!-- END content -->
        </div><!-- END wrapper -->
<!-- CONNECT BUTTON -->
<button id="connectBtn" style="
  position: fixed; bottom: 20px; right: 20px;
  background: #1cc88a; color: white;
  border: none; padding: 10px 20px;
  border-radius: 10px; font-weight: bold;
  cursor: pointer;">üîå Connect</button>

<script>
let port, reader;

/* ======================================================
   SERIAL CONNECTION
====================================================== */
async function connectSerial() {
  try {
    port = await navigator.serial.requestPort();
    await port.open({ baudRate: 115200 });

    console.log("‚úÖ Connected to ESP32");

    const decoder = new TextDecoderStream();
    port.readable.pipeTo(decoder.writable);

    const input = decoder.readable.getReader();
    let buffer = "";

    while (true) {
      const { value, done } = await input.read();
      if (done) break;

      if (value) {
        buffer += value;

        let lines = buffer.split("\n");
        buffer = lines.pop();

        for (let line of lines) {
          line = line.trim();
          if (line.length === 0) continue;

          try {
            const data = JSON.parse(line);
            updateDashboard(data);
          } catch (e) {
            console.warn("Bad JSON:", line);
          }
        }
      }
    }

  } catch (err) {
    console.error("Serial error:", err);
  }
}

document.getElementById("connectBtn").addEventListener("click", connectSerial);


/* ======================================================
   DASHBOARD UPDATE FUNCTION ‚Äî FIXED
====================================================== */
function updateDashboard(data) {

    console.log("LIVE DATA:", data);

    /* ============================
       TEMPERATURE (0‚Äì50¬∞C)
    ============================ */
    window.liveTemp = Number(data.temp);
    let tNorm = window.liveTemp / 50;
    tNorm = Math.max(0, Math.min(tNorm, 1));

    if (window.ove06p1) {
        window.ove06p1.animate(tNorm);
        window.ove06p1.setText(
            '<span style="color:#01ffff;">TEMP</span><br>' +
            window.liveTemp.toFixed(1) + "¬∞C"
        );
    }

    /* ============================
       HUMIDITY (0‚Äì100%)
    ============================ */
    window.liveHum = Number(data.hum);
    let hNorm = window.liveHum / 100;

    if (window.ove13p1) window.ove13p1.animate(hNorm);
    if (window.eats11humid) window.eats11humid.animate(hNorm);

    /* ============================
       SOUND (normalize 0‚Äì5)
    ============================ */
	//Soundbar
    window.liveSound = Number(data.sound);
    let sNorm = Math.min(window.liveSound / 10, 1);

    if (window.ove07p1) window.ove07p1.animate(sNorm);

    /* ============================
       VIBRATION (normalize 0‚Äì5)
    ============================ */

	//vibrationbar
    window.liveVib = Number(data.vibration);
    let vNorm = Math.min(window.liveVib / 5, 1);

    if (window.ove08p1) window.ove08p1.animate(vNorm);

    /* ============================
       EATS11 TEMP
    ============================ */
    if (window.eats11temp) {
        window.eats11temp.animate(window.liveTemp / 40);
    }

    /* ============================
       LIVE TEXT VALUES (BOTTOM)
    ============================ */
    setText("temp_live", window.liveTemp.toFixed(1) + " ¬∞C");
    setText("hum_live", window.liveHum.toFixed(1) + " %");
    setText("current_live", data.current.toFixed(2) + " A");
    setText("mag_live", data.mag.toFixed(3));
    setText("vibration_live", window.liveVib.toFixed(3));
    setText("sound_live", window.liveSound.toFixed(3));

    /* ============================
       CONNECTION STATUS
    ============================ */
    document.getElementById("conn_num").innerText = 1;

    /* ============================
       STABLE CHECK (for motor)
    ============================ */
    if (window.liveTemp >= 20 && window.liveTemp <= 40) {
        document.getElementById("stable_num").innerText = 1;
    } else {
        document.getElementById("stable_num").innerText = 0;
    }
}

/* Utility for updating text */
function setText(id, text) {
    let el = document.getElementById(id);
    if (el) el.innerText = text;
}
</script>

<!-- DEBUG LIVE VALUES -->
<!-- <div id="temp_live" style="color:white;font-size:18px;"></div>
<div id="hum_live" style="color:white;font-size:18px;"></div>
<div id="current_live" style="color:white;font-size:18px;"></div>
<div id="mag_live" style="color:white;font-size:18px;"></div>
<div id="vibration_live" style="color:white;font-size:18px;"></div>
<div id="sound_live" style="color:white;font-size:18px;"></div> -->

</body>
</html>
